name: Local XRT Deployment for Gemm

on: [push]

jobs:
  test-xrt:
    runs-on: [self-hosted, linux, x64]

    steps:
      - name: Check XRT SMI
        run: |
          echo "Checking xrt-smi examine"
          xrt-smi examine

      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python (optional if already on runner)
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Check Graphviz installation
        run: |
          if ! command -v dot >/dev/null 2>&1; then
            echo "❌ Graphviz ('dot') not found in PATH. Please install it on the runner."
            exit 1
          else
            echo "✅ Graphviz is installed."
          fi

      - name: Set up environment and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          bash setup_mlir_aie_requirements.sh

      - name: Run Snakemake workflow
        run: |
          source setup_mlir_aie_pythonpath.sh
          snakemake -j 1 --forceall